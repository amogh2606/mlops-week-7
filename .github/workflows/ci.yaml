name: Continuous Deployment to GKE

on:
  push:
    branches:
      - main
      - week6 # Deployment branch
  pull_request:
    branches:
      - main
      - week6

# Root-level Environment Variables
env:
  PROJECT_ID: week-1-474208 
  GKE_CLUSTER: iris-mlops-cluster
  GKE_ZONE: us-central1-c
  IMAGE_NAME: iris-fastapi-api
  GAR_LOCATION: us-central1
  GAR_REPO: mlops-repository
  IMAGE_URL: ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPO }}/${{ env.IMAGE_NAME }}

jobs:
  # ------------------------------------------------------------------
  # JOB 1: Continuous Integration (Tests & DVC Data Pull)
  # ------------------------------------------------------------------
  ci-tests:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          sudo apt-get update
          pip install -r requirements.txt
          
      - name: Set Google Cloud Credentials (Auth for DVC Data Pull)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          
      - name: DVC Pull Data
        run: |
          # Pulls the data file needed for Pytest evaluation
          dvc remote add -d gcs_bucket gs://week-2-mlops-bucket/dvc_remote --force
          dvc config core.no_scm true
          dvc pull data/V3_augmented.csv.dvc --force
          
      - name: Run Pytest Validation and Evaluation Tests
        run: pytest tests/test_pipeline.py

      - name: Setup CML ðŸ› ï¸
        uses: iterative/setup-cml@v2
        
      - name: Create CML Sanity Report
        if: github.event_name == 'pull_request'
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "## CI Pipeline Status: PASSED âœ…" > report.md
          echo "CI tests passed. Deployment eligible upon merge." >> report.md
          cml comment create report.md

  # ------------------------------------------------------------------
  # JOB 2: Continuous Deployment & Stress Test
  # ------------------------------------------------------------------
  build-and-deploy:
    # Runs only if CI passed AND it's a push (not a PR check)
    if: github.event_name == 'push' && success()
    runs-on: ubuntu-latest
    needs: [ci-tests] # Dependency: Must wait for tests to pass

    # --- CHANGE 1: ADD PERMISSIONS FOR CML ---
    permissions:
      contents: write
      pull-requests: write # Required to post comments
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # --- 1. GCP Authentication (For Docker/GAR/GKE) ---
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev --quiet
        
      # --- 2. Build and Push Docker Image ---
      - name: Create GCP Key File for Docker Build
        run: |
          echo '${{ secrets.GCP_SA_KEY }}' > gcp_key.json

      - name: Build and Push Docker Image
        run: |
          IMAGE_TAG=${{ github.sha }}
          IMAGE_PATH=${{ env.IMAGE_URL }}:${IMAGE_TAG}
          
          docker build -t ${IMAGE_PATH} .
          docker push ${IMAGE_PATH}
          
          rm gcp_key.json

      # --- 3. Deploy to GKE ---
      - name: Get GKE Credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_ZONE }}

      - name: Deploy to GKE
        run: |
          IMAGE_TAG=${{ github.sha }}
          IMAGE_PATH=${{ env.IMAGE_URL }}:${IMAGE_TAG}

          echo "Initiating rolling update with image: ${IMAGE_PATH}"
          kubectl apply -f deployment.yaml
          kubectl set image deployment/iris-api-deployment iris-api-container=${IMAGE_PATH}
          kubectl rollout status deployment/iris-api-deployment --timeout=5m

      # --- 4. CML SETUP (FOR THIS JOB) ---
      # --- CHANGE 2: ADD CML SETUP ---
      - name: Setup CML ðŸ› ï¸
        uses: iterative/setup-cml@v2
        
      # --- 5. STRESS TEST AND REPORT ---
      - name: Install wrk
        run: |
          sudo apt-get update
          sudo apt-get install -y wrk

      # --- CHANGE 3: MODIFY STRESS TEST TO CAPTURE & POST ---
      - name: Wait for LoadBalancer IP, Run Stress Test, and Report
        # Add the REPO_TOKEN for CML to authenticate
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Waiting for LoadBalancer IP to be provisioned..."
          SERVICE_IP=""
          for i in {1..30}; do
            SERVICE_IP=$(kubectl get service iris-api-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
            if [ -n "$SERVICE_IP" ]; then
              echo "LoadBalancer IP found: $SERVICE_IP"
              break
            fi
            echo "Waiting for IP... ($i/30)"
            sleep 10
          done

          if [ -z "$SERVICE_IP" ]; then
            echo "Error: LoadBalancer IP not provisioned after 5 minutes."
            kubectl get service iris-api-service
            exit 1
          fi

          echo "--- Running Scenario 1: Autoscaling Test (1000 concurrent requests) ---"
          
          # Create the report header
          echo "## ðŸš€ GKE Stress Test Report" > report.md
          echo "" >> report.md
          echo "Load test results for commit \`${{ github.sha }}\`:" >> report.md
          echo "\`\`\`" >> report.md # Start a code block for the output
          
          # Run wrk and append its output (stdout and stderr) to report.md
          wrk -t8 -c1000 -d30s http://$SERVICE_IP/health 2>&1 | tee -a report.md
          
          echo "\`\`\`" >> report.md # End the code block
          echo "" >> report.md
          echo "Test complete. Check GKE console for HPA activity." >> report.md

          # Post the captured report.md file as a commit comment
          cml comment create report.md